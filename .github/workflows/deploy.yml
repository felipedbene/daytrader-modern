name: Build & Deploy DayTrader to AIX

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  LIBERTY_HOME: /opt/IBM/WebSphere/Liberty
  MINIO_BUCKET: daytrader-artifacts
  MINIO_ENDPOINT: https://minio-api.k8s.debene.name

jobs:
  build:
    runs-on: [self-hosted, homelab]
    steps:
      - uses: actions/checkout@v4

      - name: Install homelab CA + tools
        env:
          HOMELAB_CA_CERT: ${{ secrets.HOMELAB_CA_CERT }}
        run: |
          # Install homelab CA cert from secret
          echo "$HOMELAB_CA_CERT" > /usr/local/share/ca-certificates/homelab-ca.crt
          update-ca-certificates

          # Install Maven if not present
          if ! command -v mvn &>/dev/null; then
            curl -sL https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz | tar xz -C /opt
            ln -sf /opt/apache-maven-3.9.6/bin/mvn /usr/local/bin/mvn
          fi

          # Install MinIO client if not present
          if ! command -v mc &>/dev/null; then
            curl -sL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
            chmod +x /usr/local/bin/mc
          fi

          mc --version

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload WAR to MinIO
        env:
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
        run: |
          mc alias set homelab "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
          mc mb --ignore-existing homelab/$MINIO_BUCKET

          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          WAR_FILE=$(ls daytrader-ee7-web/target/*.war | head -1)
          EAR_FILE=$(ls daytrader-ee7/target/*.ear | head -1)

          mc cp "$WAR_FILE" "homelab/$MINIO_BUCKET/daytrader-${TIMESTAMP}.war"
          mc cp "$WAR_FILE" "homelab/$MINIO_BUCKET/daytrader-latest.war"
          if [ -n "$EAR_FILE" ]; then
            mc cp "$EAR_FILE" "homelab/$MINIO_BUCKET/daytrader-${TIMESTAMP}.ear"
            mc cp "$EAR_FILE" "homelab/$MINIO_BUCKET/daytrader-latest.ear"
          fi

          echo "‚úÖ Uploaded to MinIO: daytrader-${TIMESTAMP}.war"
          echo "üì¶ Latest: ${MINIO_ENDPOINT}/${MINIO_BUCKET}/daytrader-latest.war"

  deploy:
    needs: build
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy EAR to AIX
        env:
          AIX_HOST: ${{ secrets.AIX_HOST }}
          AIX_DEPLOY_KEY: ${{ secrets.AIX_DEPLOY_KEY }}
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "$AIX_DEPLOY_KEY" > ~/.ssh/aix_deploy
          chmod 600 ~/.ssh/aix_deploy
          SSH="ssh -o StrictHostKeyChecking=no -i ~/.ssh/aix_deploy deploy@$AIX_HOST"

          # Download latest EAR from MinIO (use HTTP ‚Äî AIX curl lacks homelab CA)
          $SSH "curl -s http://10.0.2.81:9000/daytrader-artifacts/daytrader-latest.ear \
            -o /opt/IBM/WebSphere/wlp/usr/servers/defaultServer/apps/daytrader-ee7.ear"

          # Restart Liberty
          $SSH "export JAVA_HOME=/usr/java8_64 && /opt/IBM/WebSphere/wlp/bin/server stop defaultServer 2>/dev/null || true"
          $SSH "export JAVA_HOME=/usr/java8_64 && /opt/IBM/WebSphere/wlp/bin/server start defaultServer"

          # Health check
          sleep 30
          $SSH "curl -s -o /dev/null -w '%{http_code}' http://localhost:9080/daytrader/" | grep -q 200 && echo "‚úÖ Deployed!" || echo "‚ö†Ô∏è Health check failed"

          # Cleanup
          rm -f ~/.ssh/aix_deploy
