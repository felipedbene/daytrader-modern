name: Build & Deploy DayTrader to AIX

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  LIBERTY_HOME: /opt/IBM/WebSphere/Liberty
  MINIO_BUCKET: daytrader-artifacts
  MINIO_ENDPOINT: https://minio-api.k8s.debene.name

jobs:
  build:
    runs-on: [self-hosted, homelab]
    steps:
      - uses: actions/checkout@v4

      - name: Install homelab CA + tools
        env:
          HOMELAB_CA_CERT: ${{ secrets.HOMELAB_CA_CERT }}
        run: |
          # Install homelab CA cert from secret
          echo "$HOMELAB_CA_CERT" > /usr/local/share/ca-certificates/homelab-ca.crt
          update-ca-certificates

          # Install Maven if not present
          if ! command -v mvn &>/dev/null; then
            curl -sL https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz | tar xz -C /opt
            ln -sf /opt/apache-maven-3.9.6/bin/mvn /usr/local/bin/mvn
          fi

          # Install MinIO client if not present
          if ! command -v mc &>/dev/null; then
            curl -sL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
            chmod +x /usr/local/bin/mc
          fi

          mc --version

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload EAR to MinIO
        env:
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
        run: |
          mc alias set homelab "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
          mc mb --ignore-existing homelab/$MINIO_BUCKET

          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          WAR_FILE=$(ls daytrader-ee7-web/target/*.war | head -1)
          EAR_FILE=$(ls daytrader-ee7/target/*.ear | head -1)

          mc cp "$WAR_FILE" "homelab/$MINIO_BUCKET/daytrader-${TIMESTAMP}.war"
          mc cp "$WAR_FILE" "homelab/$MINIO_BUCKET/daytrader-latest.war"
          if [ -n "$EAR_FILE" ]; then
            mc cp "$EAR_FILE" "homelab/$MINIO_BUCKET/daytrader-${TIMESTAMP}.ear"
            mc cp "$EAR_FILE" "homelab/$MINIO_BUCKET/daytrader-latest.ear"
          fi

          echo "‚úÖ Uploaded to MinIO: daytrader-${TIMESTAMP}.ear"

  deploy:
    needs: build
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy EAR to AIX
        env:
          AIX_HOST: ${{ secrets.AIX_HOST }}
          AIX_DEPLOY_KEY: ${{ secrets.AIX_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AIX_DEPLOY_KEY" > ~/.ssh/aix_deploy
          chmod 600 ~/.ssh/aix_deploy
          SSH="ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i ~/.ssh/aix_deploy root@$AIX_HOST"

          LIBERTY="/opt/IBM/WebSphere/wlp"
          JAVA="export JAVA_HOME=/usr/java8_64 &&"
          DERBY_DB="$LIBERTY/usr/shared/resources/data/tradedb"
          APP_PORT=9082
          APP_URL="http://localhost:${APP_PORT}/daytrader"

          # ‚îÄ‚îÄ 1. Stop Liberty & wipe Derby for a clean slate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          echo "‚èπÔ∏è  Stopping Liberty..."
          $SSH "$JAVA $LIBERTY/bin/server stop defaultServer 2>/dev/null; true"
          $SSH "rm -rf $DERBY_DB"
          echo "üóëÔ∏è  Derby DB wiped"

          # ‚îÄ‚îÄ 2. Deploy latest EAR (use HTTP ‚Äî AIX curl lacks homelab CA) ‚îÄ‚îÄ‚îÄ‚îÄ
          echo "üì¶ Deploying EAR..."
          $SSH "curl -s --max-time 120 http://10.0.2.81:9000/daytrader-artifacts/daytrader-latest.ear \
            -o $LIBERTY/usr/servers/defaultServer/apps/daytrader-ee7.ear"

          # ‚îÄ‚îÄ 3. Start Liberty (Derby creates a fresh empty database) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          echo "‚ñ∂Ô∏è  Starting Liberty..."
          $SSH "$JAVA $LIBERTY/bin/server start defaultServer"

          # ‚îÄ‚îÄ 4. Wait for app to respond on correct port ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          echo "‚è≥ Waiting for Liberty to be ready..."
          for i in $(seq 1 30); do
            sleep 10
            code=$($SSH "curl -s -o /dev/null -w '%{http_code}' --max-time 5 ${APP_URL}/ 2>/dev/null" 2>/dev/null || echo "000")
            if [ "$code" = "200" ]; then
              echo "‚úÖ Liberty responded after $((i * 10))s"
              break
            fi
            echo "  [$((i * 10))s] HTTP $code ‚Äî still waiting..."
          done

          # Extra grace period for DataSource connection pool to warm up
          echo "‚è≥ Waiting 30s for DataSource pool to stabilise..."
          sleep 30

          # ‚îÄ‚îÄ 5. Create DB tables (retry ‚Äî TradeDirect init is timing-sensitive)
          echo "üõ†Ô∏è  Creating DB tables..."
          TABLES_OK=false
          for i in $(seq 1 6); do
            result=$($SSH "curl -s --max-time 120 '${APP_URL}/config?action=buildDBTables'" 2>/dev/null)
            if echo "$result" | grep -q "successfully created"; then
              echo "‚úÖ Tables created on attempt $i"
              TABLES_OK=true
              break
            fi
            echo "  Attempt $i: buildDBTables not ready yet (retrying in 15s)..."
            sleep 15
          done

          if [ "$TABLES_OK" != "true" ]; then
            echo "‚ùå buildDBTables failed after all retries ‚Äî aborting"
            rm -f ~/.ssh/aix_deploy
            exit 1
          fi

          # ‚îÄ‚îÄ 6. Restart Liberty for clean EJB/JPA state after DDL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          echo "üîÑ Restarting Liberty for clean EJB state..."
          $SSH "$JAVA $LIBERTY/bin/server stop defaultServer"
          $SSH "$JAVA $LIBERTY/bin/server start defaultServer"

          # ‚îÄ‚îÄ 7. Wait for Liberty to be ready again ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          echo "‚è≥ Waiting for Liberty to restart..."
          for i in $(seq 1 30); do
            sleep 10
            code=$($SSH "curl -s -o /dev/null -w '%{http_code}' --max-time 5 ${APP_URL}/ 2>/dev/null" 2>/dev/null || echo "000")
            if [ "$code" = "200" ]; then
              echo "‚úÖ Liberty back up after $((i * 10))s"
              break
            fi
            echo "  [$((i * 10))s] HTTP $code ‚Äî still waiting..."
          done

          # Extra grace period before populating
          echo "‚è≥ Waiting 30s for DataSource pool to stabilise..."
          sleep 30

          # ‚îÄ‚îÄ 8. Populate DB (10 000 quotes + 15 000 users ‚Äî takes ~10 min) ‚îÄ‚îÄ
          echo "üìä Populating database (this takes several minutes)..."
          $SSH "curl -s --max-time 1200 '${APP_URL}/config?action=buildDB' -o /dev/null"
          echo "‚úÖ Database populated"

          # ‚îÄ‚îÄ 9. Health check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          sleep 20
          code=$($SSH "curl -s -o /dev/null -w '%{http_code}' --max-time 10 ${APP_URL}/" 2>/dev/null || echo "000")
          if [ "$code" = "200" ]; then
            echo "‚úÖ Deployed and healthy!"
          else
            echo "‚ö†Ô∏è  Health check returned HTTP $code"
          fi

          rm -f ~/.ssh/aix_deploy
