name: Build & Deploy DayTrader to P8 Gentoo

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: deploy-p8
  cancel-in-progress: true

env:
  P8_HOST: ${{ secrets.AIX_HOST }}
  DEPLOY_DIR: /home/felipe/daytrader-modern

jobs:
  build:
    runs-on: [self-hosted, homelab]
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Install Maven
        run: |
          if ! command -v mvn &>/dev/null; then
            curl -sL https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz | tar xz -C /opt
            ln -sf /opt/apache-maven-3.9.6/bin/mvn /usr/local/bin/mvn
          fi
          mvn --version

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: daytrader-ear
          path: |
            daytrader-ee7/target/daytrader-ee7.ear
            daytrader-ee7-web/target/*.war

  deploy:
    needs: build
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: daytrader-ear
          path: .

      - name: Deploy to P8 Gentoo (Docker)
        env:
          DEPLOY_KEY: ${{ secrets.AIX_DEPLOY_KEY }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set +e
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/p8_deploy
          chmod 600 ~/.ssh/p8_deploy
          SSH="ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i ~/.ssh/p8_deploy felipe@$P8_HOST"
          SCP="scp -o StrictHostKeyChecking=no -i ~/.ssh/p8_deploy"

          echo "üì¶ Syncing source to P8..."
          # Sync EAR and Dockerfile
          $SCP daytrader-ee7/target/daytrader-ee7.ear felipe@$P8_HOST:$DEPLOY_DIR/daytrader-ee7/target/daytrader-ee7.ear
          $SCP Dockerfile docker-compose.yml felipe@$P8_HOST:$DEPLOY_DIR/
          $SCP daytrader-ee7/src/main/liberty/config/server.xml felipe@$P8_HOST:$DEPLOY_DIR/daytrader-ee7/src/main/liberty/config/server.xml

          echo "üê≥ Rebuilding Docker image on P8..."
          $SSH "cd $DEPLOY_DIR && docker compose build --no-cache 2>&1 | tail -5"

          # ‚îÄ‚îÄ Write .env file for docker compose (secrets never touch CLI args) ‚îÄ‚îÄ
          $SSH "printf 'DB_PASSWORD=%s\n' '${DB_PASSWORD}' > $DEPLOY_DIR/.env && chmod 600 $DEPLOY_DIR/.env"

          echo "üîÑ Restarting container..."
          $SSH "cd $DEPLOY_DIR && docker compose down && docker compose up -d 2>&1"

          echo "‚è≥ Waiting for Liberty to start..."
          for i in $(seq 1 24); do
            sleep 10
            code=$($SSH "curl -s -o /dev/null -w '%{http_code}' --max-time 5 http://127.0.0.1:9080/daytrader/" 2>/dev/null || true)
            code=${code:-000}
            if [ "$code" = "200" ] || [ "$code" = "302" ]; then
              echo "‚úÖ DayTrader up after $((i * 10))s (HTTP $code)"
              break
            fi
            echo "  [$((i * 10))s] HTTP $code"
          done

          if [ "$code" = "000" ]; then
            echo "‚ö†Ô∏è  Liberty not responding ‚Äî checking logs..."
            $SSH "cd $DEPLOY_DIR && docker compose logs --tail=30" 2>/dev/null || true
            rm -f ~/.ssh/p8_deploy
            exit 1
          fi

          # Tables are auto-created by JPA/EclipseLink at startup.
          # buildDBTables uses raw DDL but has no PostgreSQL script ‚Äî skip it.
          echo "üóÑÔ∏è Seeding database (buildDB via EJB/JPA)..."
          $SSH "curl -sf --max-time 600 'http://127.0.0.1:9080/daytrader/config?action=buildDB'" \
            && echo "  ‚úÖ Test data seeded" || echo "  ‚ö†Ô∏è buildDB returned non-zero"

          echo "üîç Verifying quotes exist after seeding..."
          QUOTE_CHECK=$($SSH "curl -sf --max-time 15 'http://127.0.0.1:9080/daytrader/api/quotes'" 2>/dev/null | head -c 200 || true)
          if echo "$QUOTE_CHECK" | grep -q 'symbol'; then
            echo "  ‚úÖ Quotes verified in DB"
          else
            echo "  ‚ö†Ô∏è No quotes found ‚Äî buildDB may have failed"
            echo "  Response: $QUOTE_CHECK"
          fi

          echo "üë§ Registering Authentik user in DayTrader..."
          $SSH "curl -sf --max-time 30 'http://127.0.0.1:9080/daytrader/app' \
            --data-urlencode 'action=register' \
            --data-urlencode 'user id=felipe' \
            --data-urlencode 'passwd=xxx' \
            --data-urlencode 'confirm passwd=xxx' \
            --data-urlencode 'Full Name=Felipe Debene' \
            --data-urlencode 'Credit Card Number=0000-0000-0000-0000' \
            --data-urlencode 'money=100000' \
            --data-urlencode 'email=felipe@debene.dev' \
            --data-urlencode 'snail mail=nowhere'" \
            && echo "  ‚úÖ User 'felipe' registered" || echo "  ‚ö†Ô∏è Registration returned non-zero (user may already exist)"

          # Restart Liberty so MarketSummarySingleton initializes with populated DB.
          # The @Singleton EJB fails permanently if it starts before quotes exist.
          echo "üîÑ Restarting container (MarketSummarySingleton needs populated DB at startup)..."
          $SSH "cd $DEPLOY_DIR && docker compose restart 2>&1"
          for i in $(seq 1 24); do
            sleep 10
            code=$($SSH "curl -s -o /dev/null -w '%{http_code}' --max-time 5 http://127.0.0.1:9080/daytrader/" 2>/dev/null || true)
            code=${code:-000}
            if [ "$code" = "200" ] || [ "$code" = "302" ]; then
              echo "‚úÖ DayTrader back up after $((i * 10))s (HTTP $code)"
              break
            fi
            echo "  [$((i * 10))s] HTTP $code"
          done

          echo "üîç Verifying quotes persist after restart..."
          QUOTE_CHECK=$($SSH "curl -sf --max-time 15 'http://127.0.0.1:9080/daytrader/api/quotes'" 2>/dev/null | head -c 200 || true)
          if echo "$QUOTE_CHECK" | grep -q 'symbol'; then
            echo "  ‚úÖ Quotes still present after restart"
          else
            echo "  ‚ùå Quotes LOST after restart ‚Äî EclipseLink may be dropping tables"
            echo "  Response: $QUOTE_CHECK"
          fi

          rm -f ~/.ssh/p8_deploy

  notify:
    needs: [build, deploy]
    runs-on: [self-hosted, homelab]
    if: always()
    steps:
      - name: Discord notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            COLOR=3066993; TITLE="‚úÖ DayTrader Deploy to P8 Success"
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            COLOR=15158332; TITLE="‚ùå DayTrader Build Failed"
          elif [ "${{ needs.deploy.result }}" = "failure" ]; then
            COLOR=15158332; TITLE="‚ùå DayTrader Deploy to P8 Failed"
          elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
            COLOR=16776960; TITLE="‚è≠Ô∏è DayTrader Deploy Skipped"
          else
            COLOR=8421504; TITLE="‚ö†Ô∏è DayTrader Pipeline: ${{ needs.deploy.result }}"
          fi
          curl -s -H "Content-Type: application/json" \
            -d "{\"embeds\":[{\"title\":\"$TITLE\",\"description\":\"Commit: \`${GITHUB_SHA::7}\`\nBranch: \`$GITHUB_REF_NAME\`\nBy: $GITHUB_ACTOR\nTarget: P8 Gentoo (Docker)\",\"color\":$COLOR,\"url\":\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID\"}]}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
