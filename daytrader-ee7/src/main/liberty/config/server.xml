<?xml version="1.0" encoding="UTF-8"?>
<server description="Sample Server">

    <featureManager>
        <feature>ejb-3.2</feature>
        <feature>servlet-4.0</feature>
        <feature>jsf-2.3</feature>
        <feature>jpa-2.2</feature>
        <feature>mdb-3.2</feature>
        <feature>wasJmsServer-1.0</feature>
        <feature>wasJmsClient-2.0</feature>
        <feature>cdi-2.0</feature>
        <feature>websocket-1.1</feature>
        <feature>concurrent-1.0</feature>
        <feature>jsonp-1.1</feature>
        <feature>beanValidation-2.0</feature>
        <feature>localConnector-1.0</feature>
        <!-- REST API features -->
        <feature>jaxrs-2.1</feature>
        <feature>jsonb-1.0</feature>
        <!-- JDBC feature for PostgreSQL -->
        <feature>jdbc-4.2</feature>
        <!-- OIDC features -->
        <feature>openidConnectClient-1.0</feature>
        <feature>transportSecurity-1.0</feature>
        <feature>appSecurity-3.0</feature>
    </featureManager>

    <authData id="TradeAdminAuthData" user="admin" password="changeit"/>

    <!-- Default SSL/TLS config (required for OIDC client) -->
    <keyStore id="defaultKeyStore" password="liberty-ks-2026"/>

    <!-- Auth filter: protect entire /daytrader app with OIDC -->
    <authFilter id="appAuthFilter">
        <requestUrl urlPattern="/daytrader" matchType="contains"/>
    </authFilter>

    <!-- OIDC Configuration - Authentik -->
    <openidConnectClient id="authentikOIDC"
        clientId="${env.OIDC_CLIENT_ID:daytrader}"
        clientSecret="${env.OIDC_CLIENT_SECRET:daytrader-oidc-secret-2026}"
        discoveryEndpointUrl="${env.OIDC_DISCOVERY_URL:https://auth.k8s.debene.name/application/o/daytrader/.well-known/openid-configuration}"
        signatureAlgorithm="RS256"
        scope="openid profile email"
        redirectToRPHostAndPort="${env.OIDC_REDIRECT_HOST:https://aix.debene.dev}"
        mapIdentityToRegistryUser="true"
        userIdentityToCreateSubject="preferred_username"
        httpsRequired="false"
        disableLtpaCookie="false"
        authFilterRef="appAuthFilter"
    />

    <!-- Security role mapping -->
    <application-bnd>
        <security-role name="AllAuthenticated">
            <special-subject type="ALL_AUTHENTICATED_USERS"/>
        </security-role>
    </application-bnd>

	<!-- allow reuse of 'busy' ports for fast server recycling on linux (where ports remain blocked for up to 2 mins after server stops) ${tradelite.http.port} set in bootstrap.properties --> 
	<httpEndpoint host="*" httpPort="9080" httpsPort="9443" id="defaultHttpEndpoint"> 
		<tcpOptions soReuseAddr="true"/> 
		<httpOptions maxKeepAliveRequests="-1"/>
	</httpEndpoint>

	<iiopEndpoint id="defaultIiopEndpoint" iiopPort="2809" iiopsPort="2810"/>
	
	<application id="daytrader7" location="daytrader-ee7.ear" name="daytrader7"/>

	<connectionManager agedTimeout="-1" connectionTimeout="0" id="conMgr1" maxIdleTime="-1" maxPoolSize="100" minPoolSize="100" purgePolicy="FailingConnectionOnly" reapTime="-1"/> 

	<!-- ========================= DATABASE CONFIGURATION ========================= -->
	<!-- Switch between Derby (local dev) and PostgreSQL (AIX production) -->
	<!-- Comment out one datasource block and uncomment the other -->

	<!-- Derby DataSource (for local development ONLY) -->
	<!--
	<jdbcDriver id="DerbyEmbedded" libraryRef="DerbyLib"/>
	<library filesetRef="DerbyFileset" id="DerbyLib"/>
	<fileset dir="${shared.resource.dir}/DerbyLibs" id="DerbyFileset" includes="derby-10.14.2.0.jar"/>

	<dataSource connectionManagerRef="conMgr1" id="DerbyDataSource" isolationLevel="TRANSACTION_READ_COMMITTED" jdbcDriverRef="DerbyEmbedded" jndiName="jdbc/TradeDataSource" statementCacheSize="60"> 
		<properties.derby.embedded createDatabase="create" databaseName="${shared.resource.dir}/data/tradedb" password="db_password" user="db_username"/> 
	</dataSource>
	-->

	<!-- PostgreSQL DataSource (for AIX production - ACTIVE) -->
	<!-- PostgreSQL JDBC driver: /opt/IBM/WebSphere/Liberty/usr/shared/resources/postgresql/postgresql-42.7.1.jar -->
	<library id="postgresLib">
		<fileset dir="${shared.resource.dir}/postgresql" includes="*.jar"/>
	</library>
	
	<dataSource connectionManagerRef="conMgr1" id="PostgresDataSource" isolationLevel="TRANSACTION_READ_COMMITTED" jndiName="jdbc/TradeDataSource" statementCacheSize="60">
		<jdbcDriver libraryRef="postgresLib"/>
		<properties URL="jdbc:postgresql://${env.DB_HOST:10.0.100.104}:${env.DB_PORT:5432}/${env.DB_NAME:tradedb}"
			user="${env.DB_USER:daytrader}" 
			password="${env.DB_PASSWORD:daytrader-p8-2026}"/>
	</dataSource>
	<!-- ========================================================================== -->

	<messagingEngine id="defaultME">
		<queue id="TradeBrokerQueue"/>
		<topicSpace id="TradeTopicSpace"/>
	</messagingEngine>

	<jmsQueueConnectionFactory connectionManagerRef="ConMgr3" jndiName="jms/TradeBrokerQCF">  
		<properties.wasJms/>
	</jmsQueueConnectionFactory> 
	<connectionManager id="ConMgr3" maxPoolSize="20"/>

	<jmsTopicConnectionFactory connectionManagerRef="ConMgr4" jndiName="jms/TradeStreamerTCF">
		<properties.wasJms/>
	</jmsTopicConnectionFactory>
	<connectionManager id="ConMgr4" maxPoolSize="20"/>

	<jmsQueue id="jms/TradeBrokerQueue" jndiName="jms/TradeBrokerQueue">
		<properties.wasJms deliveryMode="NonPersistent" queueName="TradeBrokerQueue"/>
	</jmsQueue>

	<jmsTopic id="TradeStreamerTopic" jndiName="jms/TradeStreamerTopic">
		<properties.wasJms deliveryMode="NonPersistent" topicSpace="TradeTopicSpace"/>
	</jmsTopic>

	<jmsActivationSpec id="eis/TradeBrokerMDB">
		<properties.wasJms destinationRef="jms/TradeBrokerQueue"/>
	</jmsActivationSpec>

	<jmsActivationSpec id="eis/TradeStreamerMDB">
		<properties.wasJms destinationRef="TradeStreamerTopic" destinationType="javax.jms.Topic"/>
	</jmsActivationSpec>
</server>
