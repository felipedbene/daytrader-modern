<!--
 * (C) Copyright IBM Corporation 2015.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Market Summary</title>
<script src="https://ajax.googleapis.com/ajax/libs/dojo/1.7.12/dojo/dojo.js"></script>
<link rel="stylesheet" href="style.css">
<link rel="shortcut icon" href="./favicon.ico" />

<style>
    .ms-status {
        display: inline-flex; align-items: center; gap: 0.375rem;
        font-size: 0.75rem; font-weight: 600;
        padding: 0.25rem 0.625rem; border-radius: 20px;
        background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); color: #22c55e;
    }
    .ms-status .dot {
        width: 6px; height: 6px; border-radius: 50%; background: currentColor;
        animation: ms-live 2s ease-in-out infinite;
    }
    @keyframes ms-live { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .ms-btn {
        padding: 0.3rem 0.75rem; border-radius: 6px; border: 1px solid #1e2d45;
        background: #111827; color: #7d8fa8; font-size: 0.75rem; font-weight: 600;
        cursor: pointer; transition: all 0.18s ease;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .ms-btn:hover { background: #161d2e; color: #e8edf5; border-color: #253555; }
</style>

<script>
    require(["dojo/dom", "dojo/on", "dojo/domReady!"], function(dom, on){
        var websocket, url, int;
        url = ((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/daytrader/marketsummary";

        function connect() {
            websocket = new WebSocket(url);
            websocket.onopen = function(evt) { onOpen(evt); };
            websocket.onmessage = function(evt) { onMessage(evt); };
            websocket.onerror = function(evt) { websocket.close(); };
            websocket.onclose = function(evt) { int = window.clearInterval(int); };
        }
        connect();

        on(dom.byId("connect"), "click", function(){ connect(); });
        on(dom.byId("disconnect"), "click", function(){ websocket.close(); });

        function onOpen(msg) { int = self.setInterval(function(){ update(); }, 5000); update(); }

        function setArrow(id, arrowId) {
            var el = dom.byId(id); if (!el) return;
            var v = parseFloat(el.innerHTML);
            var arrow = dom.byId(arrowId);
            if (v >= 0) {
                el.style.color = "#22c55e";
                if (arrow) { arrow.textContent = "\u25b2"; arrow.style.color = "#22c55e"; }
            } else {
                el.style.color = "#ef4444";
                if (arrow) { arrow.textContent = "\u25bc"; arrow.style.color = "#ef4444"; }
            }
        }

        function onMessage(msg) {
            var data = JSON.parse(msg.data);
            for (var k in data) { var el = dom.byId(k); if (el) el.innerHTML = data[k]; }
            if (data.hasOwnProperty('tsia'))           setArrow("tsia", "tsia-arrow");
            if (data.hasOwnProperty('change1_change')) setArrow("change1_change", "arrow_c1");
            if (data.hasOwnProperty('change2_change')) setArrow("change2_change", "arrow_c2");
            if (data.hasOwnProperty('change3_change')) setArrow("change3_change", "arrow_c3");
            if (data.hasOwnProperty('change4_change')) setArrow("change4_change", "arrow_c4");
            if (data.hasOwnProperty('change5_change')) setArrow("change5_change", "arrow_c5");
        }

        function update() { websocket.send(JSON.stringify({ action: "update" })); }
    });
</script>
</head>

<body>
<div class="dt-card">
    <div class="dt-card-header">
        <div style="display:flex;align-items:center;gap:1rem;">
            <h3 style="margin:0;">Market Summary</h3>
            <span class="ms-status"><span class="dot"></span> Live</span>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <span style="font-size:0.75rem;color:var(--text-muted);" id="date"></span>
            <button class="ms-btn" id="connect">Reconnect</button>
            <button class="ms-btn" id="disconnect">Pause</button>
        </div>
    </div>

    <div class="dt-market-summary">
        <!-- TSIA Index -->
        <div class="dt-market-index-card">
            <div class="dt-market-index-label">DayTrader Stock Index</div>
            <div style="display:flex;align-items:baseline;gap:0.5rem;margin-bottom:0.25rem;">
                <div class="dt-market-index-value" id="tsia">&#8212;</div>
                <span id="tsia-arrow" style="font-size:1.25rem;font-weight:700;"></span>
            </div>
            <div class="dt-market-index-label" style="margin-top:0.875rem;margin-bottom:0.25rem;">
                TSIA &middot; <a href="docs/glossary.html" style="color:var(--accent-blue-bright);font-weight:400;">glossary</a>
            </div>
            <div class="dt-market-index-meta">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="color:var(--text-muted);">Trading Volume</span>
                    <span id="volume" style="font-family:var(--font-mono);font-weight:600;color:var(--text-primary);">&#8212;</span>
                </div>
            </div>
        </div>

        <!-- Top Gainers -->
        <div class="dt-card" style="margin:0;padding:1.125rem;">
            <div class="dt-market-section-title"><span style="color:#22c55e;">&#9650;</span> Top Gainers</div>
            <div class="dt-market-row header"><div>Symbol</div><div>Price</div><div>Change</div></div>
            <div class="dt-market-row"><div><span id="gainer1_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="gainer1_price" style="color:var(--text-primary);">&#8212;</div><div><span id="gainer1_change" style="color:#22c55e;font-weight:700;"></span> <img src="images/arrowup.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="gainer2_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="gainer2_price" style="color:var(--text-primary);">&#8212;</div><div><span id="gainer2_change" style="color:#22c55e;font-weight:700;"></span> <img src="images/arrowup.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="gainer3_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="gainer3_price" style="color:var(--text-primary);">&#8212;</div><div><span id="gainer3_change" style="color:#22c55e;font-weight:700;"></span> <img src="images/arrowup.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="gainer4_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="gainer4_price" style="color:var(--text-primary);">&#8212;</div><div><span id="gainer4_change" style="color:#22c55e;font-weight:700;"></span> <img src="images/arrowup.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="gainer5_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="gainer5_price" style="color:var(--text-primary);">&#8212;</div><div><span id="gainer5_change" style="color:#22c55e;font-weight:700;"></span> <img src="images/arrowup.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
        </div>

        <!-- Top Losers -->
        <div class="dt-card" style="margin:0;padding:1.125rem;">
            <div class="dt-market-section-title"><span style="color:#ef4444;">&#9660;</span> Top Losers</div>
            <div class="dt-market-row header"><div>Symbol</div><div>Price</div><div>Change</div></div>
            <div class="dt-market-row"><div><span id="loser1_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="loser1_price" style="color:var(--text-primary);">&#8212;</div><div><span id="loser1_change" style="color:#ef4444;font-weight:700;"></span> <img src="images/arrowdown.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="loser2_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="loser2_price" style="color:var(--text-primary);">&#8212;</div><div><span id="loser2_change" style="color:#ef4444;font-weight:700;"></span> <img src="images/arrowdown.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="loser3_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="loser3_price" style="color:var(--text-primary);">&#8212;</div><div><span id="loser3_change" style="color:#ef4444;font-weight:700;"></span> <img src="images/arrowdown.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="loser4_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="loser4_price" style="color:var(--text-primary);">&#8212;</div><div><span id="loser4_change" style="color:#ef4444;font-weight:700;"></span> <img src="images/arrowdown.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
            <div class="dt-market-row"><div><span id="loser5_stock" style="color:var(--accent-blue-bright);font-weight:600;font-family:var(--font-family);">&#8212;</span></div><div id="loser5_price" style="color:var(--text-primary);">&#8212;</div><div><span id="loser5_change" style="color:#ef4444;font-weight:700;"></span> <img src="images/arrowdown.gif" width="7" height="7" border="0" style="opacity:0.6;vertical-align:middle;"/></div></div>
        </div>
    </div>

    <!-- Recent Changes -->
    <div class="dt-market-changes">
        <div class="dt-market-section-title" style="margin-top:0;">Recent Price Changes</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.625rem;">
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change1_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change1_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c1" style="font-size:0.6rem;"></span> <span id="change1_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change2_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change2_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c2" style="font-size:0.6rem;"></span> <span id="change2_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change3_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change3_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c3" style="font-size:0.6rem;"></span> <span id="change3_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change4_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change4_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c4" style="font-size:0.6rem;"></span> <span id="change4_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change5_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change5_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c5" style="font-size:0.6rem;"></span> <span id="change5_change">&#8212;</span></div></div>
        </div>
    </div>
</div>
</body>
</html>
