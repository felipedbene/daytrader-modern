<!--
 * (C) Copyright IBM Corporation 2015.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<style>
    .ms-status {
        display: inline-flex; align-items: center; gap: 0.375rem;
        font-size: 0.75rem; font-weight: 600;
        padding: 0.25rem 0.625rem; border-radius: 20px;
        background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); color: #22c55e;
    }
    .ms-status .dot {
        width: 6px; height: 6px; border-radius: 50%; background: currentColor;
        animation: ms-live 2s ease-in-out infinite;
    }
    .ms-status.disconnected { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.2); color: #ef4444; }
    @keyframes ms-live { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .ms-btn {
        padding: 0.3rem 0.75rem; border-radius: 6px; border: 1px solid #1e2d45;
        background: #111827; color: #7d8fa8; font-size: 0.75rem; font-weight: 600;
        cursor: pointer; transition: all 0.18s ease;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .ms-btn:hover { background: #161d2e; color: #e8edf5; border-color: #253555; }
</style>

<div class="dt-card">
    <div class="dt-card-header">
        <div style="display:flex;align-items:center;gap:1rem;">
            <h3 style="margin:0;">Market Summary</h3>
            <span class="ms-status" id="ms-status"><span class="dot"></span> Live</span>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <span style="font-size:0.75rem;color:var(--text-muted);" id="date"></span>
            <button class="ms-btn" id="connect">Refresh</button>
            <button class="ms-btn" id="disconnect">Pause</button>
        </div>
    </div>

    <div class="dt-market-summary">
        <!-- TSIA Index -->
        <div class="dt-market-index-card">
            <div class="dt-market-index-label">DayTrader Stock Index</div>
            <div style="display:flex;align-items:baseline;gap:0.5rem;margin-bottom:0.25rem;">
                <div class="dt-market-index-value" id="tsia">&#8212;</div>
                <span id="tsia-arrow" style="font-size:1.25rem;font-weight:700;"></span>
            </div>
            <div class="dt-market-index-label" style="margin-top:0.875rem;margin-bottom:0.25rem;">
                TSIA &middot; <a href="docs/glossary.html" style="color:var(--accent-blue-bright);font-weight:400;">glossary</a>
            </div>
            <div class="dt-market-index-meta">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="color:var(--text-muted);">Trading Volume</span>
                    <span id="volume" style="font-family:var(--font-mono);font-weight:600;color:var(--text-primary);">&#8212;</span>
                </div>
            </div>
        </div>

        <!-- Top Gainers -->
        <div class="dt-card" style="margin:0;padding:1.125rem;">
            <div class="dt-market-section-title"><span style="color:#22c55e;">&#9650;</span> Top Gainers</div>
            <div class="dt-market-row header"><div>Symbol</div><div>Price</div><div>Change</div></div>
            <div class="dt-market-row"><div><span id="gainer1_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="gainer1_price">&#8212;</div><div><span id="gainer1_change" style="color:#22c55e;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="gainer2_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="gainer2_price">&#8212;</div><div><span id="gainer2_change" style="color:#22c55e;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="gainer3_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="gainer3_price">&#8212;</div><div><span id="gainer3_change" style="color:#22c55e;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="gainer4_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="gainer4_price">&#8212;</div><div><span id="gainer4_change" style="color:#22c55e;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="gainer5_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="gainer5_price">&#8212;</div><div><span id="gainer5_change" style="color:#22c55e;font-weight:700;"></span></div></div>
        </div>

        <!-- Top Losers -->
        <div class="dt-card" style="margin:0;padding:1.125rem;">
            <div class="dt-market-section-title"><span style="color:#ef4444;">&#9660;</span> Top Losers</div>
            <div class="dt-market-row header"><div>Symbol</div><div>Price</div><div>Change</div></div>
            <div class="dt-market-row"><div><span id="loser1_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="loser1_price">&#8212;</div><div><span id="loser1_change" style="color:#ef4444;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="loser2_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="loser2_price">&#8212;</div><div><span id="loser2_change" style="color:#ef4444;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="loser3_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="loser3_price">&#8212;</div><div><span id="loser3_change" style="color:#ef4444;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="loser4_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="loser4_price">&#8212;</div><div><span id="loser4_change" style="color:#ef4444;font-weight:700;"></span></div></div>
            <div class="dt-market-row"><div><span id="loser5_stock" style="color:var(--accent-blue-bright);font-weight:600;">&#8212;</span></div><div id="loser5_price">&#8212;</div><div><span id="loser5_change" style="color:#ef4444;font-weight:700;"></span></div></div>
        </div>
    </div>

    <!-- Recent Changes -->
    <div class="dt-market-changes">
        <div class="dt-market-section-title" style="margin-top:0;">Recent Price Changes</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.625rem;">
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change1_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change1_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c1" style="font-size:0.6rem;"></span> <span id="change1_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change2_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change2_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c2" style="font-size:0.6rem;"></span> <span id="change2_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change3_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change3_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c3" style="font-size:0.6rem;"></span> <span id="change3_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change4_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change4_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c4" style="font-size:0.6rem;"></span> <span id="change4_change">&#8212;</span></div></div>
            <div style="text-align:center;padding:0.75rem;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border-color);"><div style="font-size:0.6875rem;color:var(--accent-blue-bright);font-weight:700;margin-bottom:0.25rem;" id="change5_stock">&#8212;</div><div style="font-family:var(--font-mono);font-weight:600;font-size:0.875rem;color:var(--text-primary);" id="change5_price">&#8212;</div><div style="font-family:var(--font-mono);font-size:0.75rem;margin-top:0.2rem;"><span id="arrow_c5" style="font-size:0.6rem;"></span> <span id="change5_change">&#8212;</span></div></div>
        </div>
    </div>
</div>

<script>
(function() {
    var timer = null;
    var apiUrl = window.location.pathname.replace(/\/app.*/, '') + '/api/market';

    function setEl(id, val) { var el = document.getElementById(id); if (el) el.innerHTML = val; }
    function setArrow(id, arrowId, val) {
        var el = document.getElementById(id); if (!el) return;
        var arrow = document.getElementById(arrowId);
        if (val >= 0) {
            el.style.color = '#22c55e';
            if (arrow) { arrow.textContent = '\u25b2'; arrow.style.color = '#22c55e'; }
        } else {
            el.style.color = '#ef4444';
            if (arrow) { arrow.textContent = '\u25bc'; arrow.style.color = '#ef4444'; }
        }
    }

    function update() {
        fetch(apiUrl).then(function(r) { return r.json(); }).then(function(data) {
            var status = document.getElementById('ms-status');
            if (status) { status.className = 'ms-status'; }

            // TSIA & volume
            var tsia = data.tsia != null ? data.tsia : (data.TSIA != null ? data.TSIA : null);
            if (tsia != null) { setEl('tsia', parseFloat(tsia).toFixed(2)); setArrow('tsia', 'tsia-arrow', parseFloat(tsia)); }
            if (data.volume != null) setEl('volume', Math.round(data.volume).toLocaleString());
            if (data.summaryDate) setEl('date', data.summaryDate);
            if (data.date) setEl('date', data.date);

            // Top gainers (array from REST API)
            var g = data.topGainers || [];
            for (var i = 0; i < 5; i++) {
                if (g[i]) {
                    setEl('gainer' + (i+1) + '_stock', g[i].symbol);
                    setEl('gainer' + (i+1) + '_price', '$' + parseFloat(g[i].price).toFixed(2));
                    setEl('gainer' + (i+1) + '_change', parseFloat(g[i].change1).toFixed(2));
                }
            }
            // Top losers
            var l = data.topLosers || [];
            for (var i = 0; i < 5; i++) {
                if (l[i]) {
                    setEl('loser' + (i+1) + '_stock', l[i].symbol);
                    setEl('loser' + (i+1) + '_price', '$' + parseFloat(l[i].price).toFixed(2));
                    setEl('loser' + (i+1) + '_change', parseFloat(l[i].change1).toFixed(2));
                }
            }
            // Recent changes (use first 5 gainers as "recent" for display)
            var recent = g.concat(l).slice(0, 5);
            for (var i = 0; i < 5; i++) {
                if (recent[i]) {
                    setEl('change' + (i+1) + '_stock', recent[i].symbol);
                    setEl('change' + (i+1) + '_price', '$' + parseFloat(recent[i].price).toFixed(2));
                    var ch = parseFloat(recent[i].change1);
                    setEl('change' + (i+1) + '_change', ch.toFixed(2));
                    setArrow('change' + (i+1) + '_change', 'arrow_c' + (i+1), ch);
                }
            }
        }).catch(function() {
            var status = document.getElementById('ms-status');
            if (status) { status.className = 'ms-status disconnected'; status.innerHTML = '<span class="dot"></span> Error'; }
        });
    }

    function start() { update(); timer = setInterval(update, 10000); }
    function stop() { if (timer) { clearInterval(timer); timer = null; } }

    document.getElementById('connect').addEventListener('click', function() { stop(); start(); });
    document.getElementById('disconnect').addEventListener('click', stop);

    start();
})();
</script>
